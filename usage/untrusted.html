<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Usage" href="usage.html" /><link rel="prev" title="Query submission via the MC2 Client" href="client.html" />

    <meta name="generator" content="sphinx-4.4.0, furo 2022.02.14.1"/>
        <title>Query submission via the Spark Driver - Opaque SQL documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=a8f031f701c6af50c9919b48f173a5785af06fac" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=25ceb02ed1c46dc30f2321ff83e92799f69dfdb9" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  --color-brand-primary: #00B0FF;
  --color-brand-content: #00B0FF;
  --color-admonition-background: #3681da;
  
  }
  body[data-theme="dark"] {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
  @media (prefers-color-scheme: dark) {
    body:not([data-theme="light"]) {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Opaque SQL  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><div class="sidebar-scroll"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">Opaque SQL  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Table of contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="client.html">Query submission via the MC<sup>2</sup> Client</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Query submission via the Spark Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="functionality.html">Supported functionalities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmarking/benchmarking.html">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/contributing.html">Contributing</a></li>
</ul>

</div></div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <div class="section" id="query-submission-via-the-spark-driver">
<h1>Query submission via the Spark Driver<a class="headerlink" href="#query-submission-via-the-spark-driver" title="Permalink to this headline">#</a></h1>
<div class="figure align-center" id="id1" style="width: 100%">
<img alt="https://mc2-project.github.io/opaque-sql/opaque-diagram.svg" src="https://mc2-project.github.io/opaque-sql/opaque-diagram.svg"/><p class="caption"><span class="caption-text">Overview of Opaque SQL running in insecure mode</span><a class="headerlink" href="#id1" title="Permalink to this image">#</a></p>
</div>
<div class="section" id="starting-opaque-sql">
<h2>Starting Opaque SQL<a class="headerlink" href="#starting-opaque-sql" title="Permalink to this headline">#</a></h2>
<p>This page goes through running Opaque SQL with the Spark driver located on the client.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This mode <strong>should not</strong> be used in any context where the full security of hardware enclaves is required. Remote attestation is disabled, and the Spark Driver has access to the key the worker enclaves use to encrypt/decrypt data. This is still offered to play around with the project and explore its API.</p>
<p>This is Opaque SQL in <strong>insecure</strong> mode, and is normally only used for testing functionalities.</p>
</div>
<div class="section" id="running-the-interactive-shell">
<h3>Running the interactive shell<a class="headerlink" href="#running-the-interactive-shell" title="Permalink to this headline">#</a></h3>
<ol class="arabic">
<li><p>Package Opaque into a fat JAR. The reason we need a fat JAR is because the JAR produced by <code class="docutils literal notranslate"><span class="pre">build/sbt</span> <span class="pre">package</span></code> does not include gRPC dependencies needed for remote attestion.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="si">${</span><span class="nv">OPAQUE_HOME</span><span class="si">}</span>
build/sbt test:assembly
</pre></div>
</div>
</li>
<li><p>Launch the Spark shell with Opaque.</p>
<p>Scala:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spark-shell --jars <span class="si">${</span><span class="nv">OPAQUE_HOME</span><span class="si">}</span>/target/scala-2.12/opaque-assembly-0.1.jar
</pre></div>
</div>
<p>Python:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pyspark --py-files <span class="si">${</span><span class="nv">OPAQUE_HOME</span><span class="si">}</span>/target/scala-2.12/opaque-assembly-0.1.jar  <span class="se">\</span>
  --jars <span class="si">${</span><span class="nv">OPAQUE_HOME</span><span class="si">}</span>/target/scala-2.12/opaque-assembly-0.1.jar
</pre></div>
</div>
<p>(we need to specify <cite>–py-files</cite> because the Python functions are placed in the .jar for easier packaging)</p>
</li>
<li><p>Alternatively, you can also run queries in Scala locally using <code class="docutils literal notranslate"><span class="pre">sbt</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>build/sbt console
</pre></div>
</div>
</li>
<li><p>Inside the Spark shell, import Opaque SQL’s <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> methods and its query planning rules.</p>
<p>Scala:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">edu</span><span class="p">.</span><span class="nn">berkeley</span><span class="p">.</span><span class="nn">cs</span><span class="p">.</span><span class="nn">rise</span><span class="p">.</span><span class="nn">opaque</span><span class="p">.</span><span class="nn">implicits</span><span class="p">.</span><span class="n">_</span>
<span class="n">edu</span><span class="p">.</span><span class="n">berkeley</span><span class="p">.</span><span class="n">cs</span><span class="p">.</span><span class="n">rise</span><span class="p">.</span><span class="n">opaque</span><span class="p">.</span><span class="nc">Utils</span><span class="p">.</span><span class="n">initOpaqueSQL</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">testing</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span>
</pre></div>
</div>
<p>Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">opaque_sql</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">init_opaque_sql</span><span class="p">(</span><span class="n">testing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="encrypting-a-dataframe-with-the-driver">
<h2>Encrypting a DataFrame with the Driver<a class="headerlink" href="#encrypting-a-dataframe-with-the-driver" title="Permalink to this headline">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Opaque SQL methods shown in this section are <em>only</em> supported in insecure mode, since the driver needs the key for encryption/decryption.</p>
</div>
<ol class="arabic">
<li><p>Create an unencrypted DataFrame.</p>
<p>Scala:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">data</span> <span class="o">=</span> <span class="nc">Seq</span><span class="p">((</span><span class="s">"foo"</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="s">"bar"</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s">"baz"</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="kd">val</span> <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="n">toDF</span><span class="p">(</span><span class="s">"word"</span><span class="p">,</span> <span class="s">"count"</span><span class="p">)</span>
</pre></div>
</div>
<p>Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">"foo"</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="s2">"bar"</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">"baz"</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">toDF</span><span class="p">(</span><span class="s2">"word"</span><span class="p">,</span> <span class="s2">"count"</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Create an encrypted DataFrame from the unencrypted version. In insecure mode, this is as easy as calling <code class="docutils literal notranslate"><span class="pre">.encrypted</span></code>.</p>
<p>Scala:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span> <span class="n">dfEncrypted</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">encrypted</span>
</pre></div>
</div>
<p>Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_encrypted</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">encrypted</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Perform any operations in the <a class="reference internal" href="functionality.html#functionalities"><span class="std std-ref">list of supported functionalities</span></a>.</p></li>
</ol>
<ol class="arabic" start="3">
<li><p>Call <code class="docutils literal notranslate"><span class="pre">.collect</span></code> or <code class="docutils literal notranslate"><span class="pre">.show</span></code> to retreive and automatically decrypt the results.</p>
<p>Scala:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">dfEncrypted</span><span class="p">.</span><span class="n">show</span>
<span class="c1">// +-----+-----+</span>
<span class="c1">// |word |count|</span>
<span class="c1">// +--99-+-----+</span>
<span class="c1">// |  foo|    4|</span>
<span class="c1">// |  bar|    1|</span>
<span class="c1">// |  baz|    5|</span>
<span class="c1">// +-----+-----+</span>
</pre></div>
</div>
<p>Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_encrypted</span><span class="o">.</span><span class="n">show</span>
<span class="c1"># +-----+-----+</span>
<span class="c1"># |word |count|</span>
<span class="c1"># +--99-+-----+</span>
<span class="c1"># |  foo|    4|</span>
<span class="c1"># |  bar|    1|</span>
<span class="c1"># |  baz|    5|</span>
<span class="c1"># +-----+-----+</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="usage.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Usage</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="client.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Query submission via the MC<sup>2</sup> Client</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2021, Octavian Sima, Wenting Zheng
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Query submission via the Spark Driver</a><ul>
<li><a class="reference internal" href="#starting-opaque-sql">Starting Opaque SQL</a><ul>
<li><a class="reference internal" href="#running-the-interactive-shell">Running the interactive shell</a></li>
</ul>
</li>
<li><a class="reference internal" href="#encrypting-a-dataframe-with-the-driver">Encrypting a DataFrame with the Driver</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    </body>
</html>